import yfinance as yf
import pandas as pd

def get_balance_sheet_history(ticker, years=4):
  """Downloads the balance sheet data for the given ticker 
  for the specified number of years.

  Args:
      ticker (str): The stock ticker symbol.
      years (int, optional): The number of years of data to retrieve. 
                            Defaults to 4.

  Returns:
      pandas.DataFrame: A DataFrame containing the balance sheet data,
                       or None if an error occurs.
  """
  try:
    stock = yf.Ticker(ticker)
    # Get the current year
    current_year = pd.to_datetime('today').year - 1
    # Calculate the start year
    start_year = last_year - 3

    # Download balance sheet data for each year
    balance_sheets = []  # Initialize the list here
    for year in range(start_year, current_year + 1):
      try:
        # Get the balance sheet for the specific year
        balance_sheet = stock.balance_sheet
        # Add a 'Year' column
        balance_sheet['Year'] = year
        balance_sheets.append(balance_sheet)
      except Exception as e:
        print(f"Error getting balance sheet for {year}: {e}")

def export_to_google_sheets(balance_sheet_data, spreadsheet_name):
    """Exports the balance sheet data to Google Sheets.

    Args:
        balance_sheet_data (pandas.DataFrame): The balance sheet data.
        spreadsheet_name (str): The name of the Google Sheet.
    """
    try:
        # Google Sheets API credentials
        scope = ['https://spreadsheets.google.com/feeds',
                 'https://www.googleapis.com/auth/drive']
        creds = ServiceAccountCredentials.from_json_keyfile_name('your_credentials.json', scope)
        client = gspread.authorize(creds)

        # Create or open the spreadsheet
        spreadsheet = client.open(spreadsheet_name)

        # Create worksheets for each year
        for year in balance_sheet_data['Year'].unique():
            sheet_name = str(year)
            try:
                worksheet = spreadsheet.add_worksheet(title=sheet_name, rows="100", cols="20")
            except gspread.exceptions.WorksheetNotFound:
                # If the worksheet already exists, get it
                worksheet = spreadsheet.worksheet(sheet_name)

            # Convert the DataFrame for the current year to a list of lists
            year_data = balance_sheet_data[balance_sheet_data['Year'] == year]
            data_to_export = [year_data.columns.tolist()] + year_data.values.tolist()

            # Update the worksheet with the data
            worksheet.update(data_to_export)

        print(f"Balance sheet data exported to Google Sheet: {spreadsheet_name}")

    except Exception as e:
        print(f"Error exporting to Google Sheets: {e}")


# Get the balance sheet data for AAPL for the last 4 years
balance_sheet_data = get_balance_sheet_history("AAPL", years=4)

if balance_sheet_data is not None:
    # Export the data to Google Sheets
    export_to_google_sheets(balance_sheet_data, "AAPL Balance Sheet") 
